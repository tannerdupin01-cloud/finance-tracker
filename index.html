<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f9fafb;
            color: #111827;
        }

        .auth-container {
            min-height: 100vh;
            background: linear-gradient(to bottom right, #dbeafe, #e0e7ff);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .auth-box {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            width: 100%;
            max-width: 28rem;
        }

        .auth-icon {
            width: 4rem;
            height: 4rem;
            background: #4f46e5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
        }

        .auth-title {
            font-size: 1.875rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .auth-subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        input:focus {
            outline: none;
            border-color: #4f46e5;
            ring: 2px;
            ring-color: #4f46e5;
        }

        .btn {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
        }

        .btn-secondary {
            background: transparent;
            color: #4f46e5;
            margin-top: 1rem;
        }

        .btn-secondary:hover {
            background: #eef2ff;
        }

        .header {
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 80rem;
            margin: 0 auto;
            padding: 1rem 1.5rem;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-email {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .btn-logout {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: #374151;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-logout:hover {
            background: #f3f4f6;
        }

        .nav-tabs {
            display: flex;
            gap: 0.25rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: #6b7280;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
        }

        .nav-tab:hover {
            color: #111827;
        }

        .nav-tab.active {
            color: #4f46e5;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #4f46e5;
        }

        .main-content {
            max-width: 80rem;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }

        .stat-card {
            display: flex;
            flex-direction: column;
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
        }

        .stat-value {
            font-size: 1.875rem;
            font-weight: bold;
        }

        .transaction-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-radius: 0.5rem;
            transition: background 0.2s;
        }

        .transaction-item:hover {
            background: #f9fafb;
        }

        .transaction-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .transaction-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .transaction-icon.income {
            background: #dcfce7;
        }

        .transaction-icon.expense {
            background: #fee2e2;
        }

        .transaction-details h4 {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .transaction-details p {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .transaction-amount {
            font-weight: 600;
        }

        .transaction-amount.income {
            color: #16a34a;
        }

        .transaction-amount.expense {
            color: #dc2626;
        }

        .progress-bar {
            width: 100%;
            height: 0.5rem;
            background: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .progress-fill.green {
            background: #22c55e;
        }

        .progress-fill.yellow {
            background: #eab308;
        }

        .progress-fill.red {
            background: #ef4444;
        }

        .btn-add {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-add:hover {
            background: #4338ca;
        }

        .form-inline {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .hidden {
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
        }

        .empty-state-icon {
            width: 4rem;
            height: 4rem;
            margin: 0 auto 1rem;
            color: #9ca3af;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }

        .budget-card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        .budget-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .budget-title {
            font-size: 1.25rem;
            font-weight: bold;
        }

        .budget-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .budget-badge.green {
            background: #dcfce7;
            color: #166534;
        }

        .budget-badge.yellow {
            background: #fef3c7;
            color: #854d0e;
        }

        .budget-badge.red {
            background: #fee2e2;
            color: #991b1b;
        }

        .budget-amounts {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .budget-progress {
            margin-bottom: 1rem;
        }

        .budget-remaining {
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .budget-remaining span {
            font-weight: 600;
            color: #111827;
        }

        .account-card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            transition: box-shadow 0.2s;
        }

        .account-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .account-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .account-icon {
            width: 3rem;
            height: 3rem;
            background: #eef2ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .account-type {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
        }

        .account-name {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .account-balance {
            font-size: 1.875rem;
            font-weight: bold;
            color: #4f46e5;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .analytics-stat {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        .analytics-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .analytics-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .add-form {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, doc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAuEIYAHBHpzRtXpNk6WDrhy_0qY5biihQ",
            authDomain: "finance-d472d.firebaseapp.com",
            projectId: "finance-d472d",
            storageBucket: "finance-d472d.firebasestorage.app",
            messagingSenderId: "145145132834",
            appId: "1:145145132834:web:58827678d3c5d4d5d2977b"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const USE_FIREBASE = true;

        // App state
        let currentUser = null;
        let activeTab = 'dashboard';
        let transactions = [];
        let budgets = [
            { id: 1, category: 'Groceries', limit: 500, spent: 320 },
            { id: 2, category: 'Entertainment', limit: 200, spent: 145 },
            { id: 3, category: 'Transportation', limit: 300, spent: 180 }
        ];
        let accounts = [];
        let recurringTransactions = [];

        // Process recurring transactions
        function processRecurring() {
            const today = new Date();
            recurringTransactions.forEach(recurring => {
                if (!recurring.lastProcessed) {
                    recurring.lastProcessed = recurring.startDate;
                }
                
                let lastDate = new Date(recurring.lastProcessed);
                let nextDate = new Date(lastDate);
                
                if (recurring.frequency === 'weekly') {
                    nextDate.setDate(nextDate.getDate() + 7);
                } else if (recurring.frequency === 'monthly') {
                    nextDate.setMonth(nextDate.getMonth() + 1);
                } else if (recurring.frequency === 'yearly') {
                    nextDate.setFullYear(nextDate.getFullYear() + 1);
                }
                
                while (nextDate <= today) {
                    const autoTransaction = {
                        id: Date.now() + Math.random(),
                        date: nextDate.toISOString().split('T')[0],
                        description: recurring.description + ' (Auto)',
                        amount: recurring.amount * (recurring.type === 'expense' ? -1 : 1),
                        category: recurring.category,
                        type: recurring.type,
                        recurringId: recurring.id
                    };
                    transactions.unshift(autoTransaction);
                    recurring.lastProcessed = nextDate.toISOString().split('T')[0];
                    
                    if (recurring.frequency === 'weekly') {
                        nextDate.setDate(nextDate.getDate() + 7);
                    } else if (recurring.frequency === 'monthly') {
                        nextDate.setMonth(nextDate.getMonth() + 1);
                    } else if (recurring.frequency === 'yearly') {
                        nextDate.setFullYear(nextDate.getFullYear() + 1);
                    }
                }
            });
        }

        // Auth functions
        async function login(email, password) {
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                await loadUserData();
                render();
            } catch (error) {
                alert('Login error: ' + error.message);
            }
        }

        async function signup(email, password) {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                
                // Create initial user document
                await setDoc(doc(db, 'users', currentUser.uid), {
                    email: currentUser.email,
                    createdAt: new Date()
                });
                
                // Add sample data
                const sampleTransactions = [
                    { date: '2024-11-15', description: 'Whole Foods', amount: -85.32, category: 'Groceries', type: 'expense', createdAt: new Date() },
                    { date: '2024-11-14', description: 'Salary Deposit', amount: 3500.00, category: 'Income', type: 'income', createdAt: new Date() },
                    { date: '2024-11-13', description: 'Netflix', amount: -15.99, category: 'Entertainment', type: 'expense', createdAt: new Date() },
                    { date: '2024-11-12', description: 'Gas Station', amount: -45.00, category: 'Transportation', type: 'expense', createdAt: new Date() }
                ];
                
                for (const tx of sampleTransactions) {
                    await addDoc(collection(db, 'users', currentUser.uid, 'transactions'), tx);
                }
                
                // Add initial budgets
                const initialBudgets = [
                    { category: 'Groceries', limit: 500, spent: 320 },
                    { category: 'Entertainment', limit: 200, spent: 145 },
                    { category: 'Transportation', limit: 300, spent: 180 }
                ];
                
                for (const budget of initialBudgets) {
                    await addDoc(collection(db, 'users', currentUser.uid, 'budgets'), budget);
                }
                
                await loadUserData();
                render();
            } catch (error) {
                alert('Signup error: ' + error.message);
            }
        }

        async function logout() {
            try {
                await signOut(auth);
                currentUser = null;
                transactions = [];
                budgets = [];
                accounts = [];
                render();
            } catch (error) {
                alert('Logout error: ' + error.message);
            }
        }

        // Load user data from Firestore
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                // Load transactions
                const txQuery = query(
                    collection(db, 'users', currentUser.uid, 'transactions'),
                    orderBy('createdAt', 'desc')
                );
                const txSnapshot = await getDocs(txQuery);
                transactions = txSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load budgets
                const budgetSnapshot = await getDocs(collection(db, 'users', currentUser.uid, 'budgets'));
                budgets = budgetSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load accounts
                const accountSnapshot = await getDocs(collection(db, 'users', currentUser.uid, 'accounts'));
                accounts = accountSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load recurring transactions
                const recurringSnapshot = await getDocs(collection(db, 'users', currentUser.uid, 'recurring'));
                recurringTransactions = recurringSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Transaction functions
        async function addTransaction(description, amount, category, type) {
            if (!currentUser) return;
            
            try {
                const transaction = {
                    date: new Date().toISOString().split('T')[0],
                    description,
                    amount: parseFloat(amount) * (type === 'expense' ? -1 : 1),
                    category,
                    type,
                    createdAt: new Date()
                };
                
                await addDoc(collection(db, 'users', currentUser.uid, 'transactions'), transaction);
                
                // Update budget if expense
                if (type === 'expense') {
                    const budget = budgets.find(b => b.category === category);
                    if (budget) {
                        const budgetRef = doc(db, 'users', currentUser.uid, 'budgets', budget.id);
                        await updateDoc(budgetRef, {
                            spent: budget.spent + parseFloat(amount)
                        });
                    }
                }
                
                await loadUserData();
                render();
            } catch (error) {
                alert('Error adding transaction: ' + error.message);
            }
        }

        async function connectAccount() {
            if (!currentUser) return;
            
            try {
                const account = {
                    name: 'Chase Checking',
                    type: 'checking',
                    balance: 5430.25,
                    createdAt: new Date()
                };
                
                await addDoc(collection(db, 'users', currentUser.uid, 'accounts'), account);
                await loadUserData();
                alert('Bank account connected! In production, this will use Plaid.');
                render();
            } catch (error) {
                alert('Error connecting account: ' + error.message);
            }
        }

        // Calculate stats
        function getStats() {
            const totalBalance = accounts.reduce((sum, acc) => sum + acc.balance, 0);
            const monthlyIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            const monthlyExpenses = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + Math.abs(t.amount), 0);
            
            return { totalBalance, monthlyIncome, monthlyExpenses };
        }

        // Render functions
        function renderAuth(isSignup = false) {
            return `
                <div class="auth-container">
                    <div class="auth-box">
                        <div class="auth-icon">
                            <svg width="32" height="32" fill="white" viewBox="0 0 24 24">
                                <path d="M21 18v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v1"></path>
                                <polyline points="15 10 20 15 15 20"></polyline>
                                <line x1="4" x2="20" y1="15" y2="15"></line>
                            </svg>
                        </div>
                        <h1 class="auth-title">Finance Tracker</h1>
                        <p class="auth-subtitle">Manage your money with ease</p>
                        
                        <form id="authForm" onsubmit="event.preventDefault(); handleAuth(${isSignup});">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="email" placeholder="you@example.com" required>
                            </div>
                            <div class="form-group">
                                <label>Password</label>
                                <input type="password" id="password" placeholder="••••••••" required>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                ${isSignup ? 'Create Account' : 'Sign In'}
                            </button>
                        </form>
                        
                        <button class="btn btn-secondary" onclick="toggleAuth()">
                            ${isSignup ? 'Already have an account? Sign in' : "Don't have an account? Sign up"}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const stats = getStats();
            return `
                <div class="grid grid-3">
                    <div class="card stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Total Balance</span>
                            <svg width="20" height="20" fill="none" stroke="#4f46e5" stroke-width="2" viewBox="0 0 24 24">
                                <line x1="12" x2="12" y1="2" y2="22"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                        </div>
                        <div class="stat-value">$${stats.totalBalance.toFixed(2)}</div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Monthly Income</span>
                            <svg width="20" height="20" fill="none" stroke="#16a34a" stroke-width="2" viewBox="0 0 24 24">
                                <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline>
                                <polyline points="16 7 22 7 22 13"></polyline>
                            </svg>
                        </div>
                        <div class="stat-value" style="color: #16a34a;">$${stats.monthlyIncome.toFixed(2)}</div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Monthly Expenses</span>
                            <svg width="20" height="20" fill="none" stroke="#dc2626" stroke-width="2" viewBox="0 0 24 24">
                                <polyline points="22 17 13.5 8.5 8.5 13.5 2 7"></polyline>
                                <polyline points="16 17 22 17 22 11"></polyline>
                            </svg>
                        </div>
                        <div class="stat-value" style="color: #dc2626;">$${stats.monthlyExpenses.toFixed(2)}</div>
                    </div>
                </div>

                <div class="grid grid-2">
                    <div class="card">
                        <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">Recent Transactions</h2>
                        ${transactions.slice(0, 5).map(t => `
                            <div class="transaction-item">
                                <div class="transaction-info">
                                    <div class="transaction-icon ${t.type}">
                                        <svg width="20" height="20" fill="none" stroke="${t.type === 'income' ? '#16a34a' : '#dc2626'}" stroke-width="2" viewBox="0 0 24 24">
                                            ${t.type === 'income' 
                                                ? '<polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline><polyline points="16 7 22 7 22 13"></polyline>'
                                                : '<polyline points="22 17 13.5 8.5 8.5 13.5 2 7"></polyline><polyline points="16 17 22 17 22 11"></polyline>'}
                                        </svg>
                                    </div>
                                    <div class="transaction-details">
                                        <h4>${t.description}</h4>
                                        <p>${t.category}</p>
                                    </div>
                                </div>
                                <div class="transaction-amount ${t.type}">
                                    ${t.amount > 0 ? '+' : ''}$${t.amount.toFixed(2)}
                                </div>
                            </div>
                        `).join('')}
                        <button class="btn btn-primary" style="margin-top: 1rem;" onclick="activeTab = 'transactions'; render();">
                            View All Transactions
                        </button>
                    </div>

                    <div class="card">
                        <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">Budget Overview</h2>
                        ${budgets.map(b => {
                            const percentage = (b.spent / b.limit) * 100;
                            const color = percentage > 90 ? 'red' : percentage > 70 ? 'yellow' : 'green';
                            return `
                                <div style="margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">
                                        <span style="font-weight: 500;">${b.category}</span>
                                        <span style="color: #6b7280;">$${b.spent} / $${b.limit}</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill ${color}" style="width: ${Math.min(percentage, 100)}%"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        <button class="btn btn-primary" style="margin-top: 1rem;" onclick="activeTab = 'budgets'; render();">
                            Manage Budgets
                        </button>
                    </div>
                </div>
            `;
        }

        function renderTransactions() {
            return `
                <div class="card">
                    <div class="section-header">
                        <h2 class="section-title">All Transactions</h2>
                        <button class="btn-add" onclick="document.getElementById('addTransactionForm').classList.toggle('hidden');">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <line x1="12" x2="12" y1="5" y2="19"></line>
                                <line x1="5" x2="19" y1="12" y2="12"></line>
                            </svg>
                            Add Transaction
                        </button>
                    </div>

                    <div id="addTransactionForm" class="add-form hidden">
                        <form onsubmit="event.preventDefault(); handleAddTransaction();">
                            <div class="form-inline">
                                <input type="text" id="txDesc" placeholder="Description" required>
                                <input type="number" id="txAmount" placeholder="Amount" step="0.01" required>
                                <select id="txCategory">
                                    <option>Groceries</option>
                                    <option>Entertainment</option>
                                    <option>Transportation</option>
                                    <option>Income</option>
                                </select>
                                <select id="txType">
                                    <option value="expense">Expense</option>
                                    <option value="income">Income</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Transaction</button>
                        </form>
                    </div>

                    ${transactions.map(t => `
                        <div class="transaction-item">
                            <div class="transaction-info">
                                <div class="transaction-icon ${t.type}">
                                    <svg width="20" height="20" fill="none" stroke="${t.type === 'income' ? '#16a34a' : '#dc2626'}" stroke-width="2" viewBox="0 0 24 24">
                                        ${t.type === 'income' 
                                            ? '<polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline><polyline points="16 7 22 7 22 13"></polyline>'
                                            : '<polyline points="22 17 13.5 8.5 8.5 13.5 2 7"></polyline><polyline points="16 17 22 17 22 11"></polyline>'}
                                    </svg>
                                </div>
                                <div class="transaction-details">
                                    <h4>${t.description}</h4>
                                    <p>${t.date} • ${t.category}</p>
                                </div>
                            </div>
                            <div class="transaction-amount ${t.type}">
                                ${t.amount > 0 ? '+$' : '-$'}${Math.abs(t.amount).toFixed(2)}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderBudgets() {
            return `
                <div class="grid grid-2">
                    ${budgets.map(b => {
                        const percentage = (b.spent / b.limit) * 100;
                        const remaining = b.limit - b.spent;
                        const color = percentage > 90 ? 'red' : percentage > 70 ? 'yellow' : 'green';
                        return `
                            <div class="budget-card">
                                <div class="budget-header">
                                    <h3 class="budget-title">${b.category}</h3>
                                    <span class="budget-badge ${color}">${percentage.toFixed(0)}%</span>
                                </div>
                                <div class="budget-progress">
                                    <div class="budget-amounts">
                                        <span>Spent: ${b.spent.toFixed(2)}</span>
                                        <span>Limit: ${b.limit.toFixed(2)}</span>
                                    </div>
                                    <div class="progress-bar" style="height: 0.75rem;">
                                        <div class="progress-fill ${color}" style="width: ${Math.min(percentage, 100)}%"></div>
                                    </div>
                                </div>
                                <div class="budget-remaining">
                                    Remaining: <span>${remaining.toFixed(2)}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderAccounts() {
            return `
                <div>
                    <div class="section-header">
                        <h2 class="section-title">Connected Accounts</h2>
                        <button class="btn-add" onclick="connectAccount();">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <rect width="20" height="14" x="2" y="5" rx="2"></rect>
                                <line x1="2" x2="22" y1="10" y2="10"></line>
                            </svg>
                            Connect Account
                        </button>
                    </div>

                    ${accounts.length === 0 ? `
                        <div class="card empty-state">
                            <div class="empty-state-icon">
                                <svg width="64" height="64" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <rect width="20" height="14" x="2" y="5" rx="2"></rect>
                                    <line x1="2" x2="22" y1="10" y2="10"></line>
                                </svg>
                            </div>
                            <h3>No accounts connected</h3>
                            <p>Connect your bank accounts via Plaid to track your finances automatically.</p>
                            <button class="btn btn-primary" onclick="connectAccount();">Connect Your First Account</button>
                        </div>
                    ` : `
                        <div class="grid grid-3">
                            ${accounts.map(acc => `
                                <div class="account-card">
                                    <div class="account-header">
                                        <div class="account-icon">
                                            <svg width="24" height="24" fill="none" stroke="#4f46e5" stroke-width="2" viewBox="0 0 24 24">
                                                <rect width="20" height="14" x="2" y="5" rx="2"></rect>
                                                <line x1="2" x2="22" y1="10" y2="10"></line>
                                            </svg>
                                        </div>
                                        <span class="account-type">${acc.type}</span>
                                    </div>
                                    <h3 class="account-name">${acc.name}</h3>
                                    <p class="account-balance">${acc.balance.toFixed(2)}</p>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function renderAnalytics() {
            const stats = getStats();
            const totalSpent = budgets.reduce((sum, b) => sum + b.spent, 0);
            const avgTransaction = stats.monthlyExpenses / (transactions.filter(t => t.type === 'expense').length || 1);
            const netCashFlow = stats.monthlyIncome - stats.monthlyExpenses;

            return `
                <div class="card">
                    <h2 class="section-title" style="margin-bottom: 1.5rem;">Spending by Category</h2>
                    ${budgets.map(b => {
                        const categoryPercentage = (b.spent / totalSpent) * 100;
                        return `
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 500;">${b.category}</span>
                                    <div style="text-align: right;">
                                        <p style="font-weight: 600;">${b.spent.toFixed(2)}</p>
                                        <p style="font-size: 0.875rem; color: #6b7280;">${categoryPercentage.toFixed(1)}%</p>
                                    </div>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="background: #4f46e5; width: ${categoryPercentage}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>

                <div class="grid grid-3" style="margin-top: 1.5rem;">
                    <div class="analytics-stat">
                        <h3 class="analytics-label">Average Transaction</h3>
                        <p class="analytics-value">${avgTransaction.toFixed(2)}</p>
                    </div>
                    <div class="analytics-stat">
                        <h3 class="analytics-label">Total Transactions</h3>
                        <p class="analytics-value">${transactions.length}</p>
                    </div>
                    <div class="analytics-stat">
                        <h3 class="analytics-label">Net Cash Flow</h3>
                        <p class="analytics-value" style="color: ${netCashFlow > 0 ? '#16a34a' : '#dc2626'};">
                            ${netCashFlow.toFixed(2)}
                        </p>
                    </div>
                </div>
            `;
        }

        function renderApp() {
            return `
                <header class="header">
                    <div class="header-content">
                        <div class="header-top">
                            <div class="logo">
                                <svg width="32" height="32" fill="#4f46e5" viewBox="0 0 24 24">
                                    <path d="M21 18v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v1"></path>
                                    <polyline points="15 10 20 15 15 20"></polyline>
                                    <line x1="4" x2="20" y1="15" y2="15"></line>
                                </svg>
                                <h1 class="logo-title">Finance Tracker</h1>
                            </div>
                            <div class="user-info">
                                <span class="user-email">${currentUser.email}</span>
                                <button class="btn-logout" onclick="logout();">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                        <polyline points="16 17 21 12 16 7"></polyline>
                                        <line x1="21" x2="9" y1="12" y2="12"></line>
                                    </svg>
                                    Sign Out
                                </button>
                            </div>
                        </div>
                        <nav class="nav-tabs">
                            <button class="nav-tab ${activeTab === 'dashboard' ? 'active' : ''}" onclick="activeTab = 'dashboard'; render();">Dashboard</button>
                            <button class="nav-tab ${activeTab === 'transactions' ? 'active' : ''}" onclick="activeTab = 'transactions'; render();">Transactions</button>
                            <button class="nav-tab ${activeTab === 'budgets' ? 'active' : ''}" onclick="activeTab = 'budgets'; render();">Budgets</button>
                            <button class="nav-tab ${activeTab === 'accounts' ? 'active' : ''}" onclick="activeTab = 'accounts'; render();">Accounts</button>
                            <button class="nav-tab ${activeTab === 'analytics' ? 'active' : ''}" onclick="activeTab = 'analytics'; render();">Analytics</button>
                            <button class="nav-tab ${activeTab === 'recurring' ? 'active' : ''}" onclick="activeTab = 'recurring'; render();">Recurring</button>
                            <button class="nav-tab ${activeTab === 'reports' ? 'active' : ''}" onclick="activeTab = 'reports'; render();">Reports</button>
                        </nav>
                    </div>
                </header>
                <main class="main-content">
                    ${activeTab === 'dashboard' ? renderDashboard() : ''}
                    ${activeTab === 'transactions' ? renderTransactions() : ''}
                    ${activeTab === 'budgets' ? renderBudgets() : ''}
                    ${activeTab === 'accounts' ? renderAccounts() : ''}
                    ${activeTab === 'analytics' ? renderAnalytics() : ''}
                    ${activeTab === 'recurring' ? renderRecurring() : ''}
                    ${activeTab === 'reports' ? renderReports() : ''}
                </main>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            if (!currentUser) {
                app.innerHTML = renderAuth(window.isSignup || false);
            } else {
                app.innerHTML = renderApp();
            }
        }

        // Event handlers
        window.handleAuth = function(isSignup) {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (isSignup) {
                signup(email, password);
            } else {
                login(email, password);
            }
        };

        window.toggleAuth = function() {
            window.isSignup = !window.isSignup;
            render();
        };

        window.handleAddTransaction = function() {
            const description = document.getElementById('txDesc').value;
            const amount = document.getElementById('txAmount').value;
            const category = document.getElementById('txCategory').value;
            const type = document.getElementById('txType').value;
            
            addTransaction(description, amount, category, type);
            document.getElementById('addTransactionForm').classList.add('hidden');
        };

        window.handleAddRecurring = async function() {
            const description = document.getElementById('recDesc').value;
            const amount = parseFloat(document.getElementById('recAmount').value);
            const category = document.getElementById('recCategory').value;
            const frequency = document.getElementById('recFrequency').value;
            const type = document.getElementById('recType').value;
            const startDate = document.getElementById('recStartDate').value;
            
            if (!currentUser) return;
            
            try {
                const recurring = {
                    description,
                    amount,
                    category,
                    frequency,
                    type,
                    startDate,
                    createdAt: new Date()
                };
                
                await addDoc(collection(db, 'users', currentUser.uid, 'recurring'), recurring);
                await loadUserData();
                document.getElementById('addRecurringForm').classList.add('hidden');
                render();
            } catch (error) {
                alert('Error adding recurring transaction: ' + error.message);
            }
        };

        window.deleteRecurring = async function(id) {
            if (!currentUser) return;
            if (!confirm('Delete this recurring transaction?')) return;
            
            try {
                const { deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                await deleteDoc(doc(db, 'users', currentUser.uid, 'recurring', id));
                await loadUserData();
                render();
            } catch (error) {
                alert('Error deleting: ' + error.message);
            }
        };

        // Initialize - Listen for auth state changes
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
            } else {
                currentUser = null;
                transactions = [];
                budgets = [];
                accounts = [];
            }
            render();
        });
    </script>
</body>
</html>