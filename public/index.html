<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoughMain - Take Control of Your Money</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f9fafb;
            color: #111827;
            line-height: 1.6;
        }

        /* Homepage Styles */
        .homepage {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-outline {
            background: transparent;
            color: white;
            border: 2px solid white;
        }

        .btn-outline:hover {
            background: white;
            color: #667eea;
        }

        .btn-primary {
            background: white;
            color: #667eea;
        }

        .btn-primary:hover {
            background: #f1f5f9;
            transform: translateY(-2px);
        }

        .hero {
            text-align: center;
            padding: 4rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .hero h1 {
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            background: linear-gradient(45deg, #ffffff, #e2e8f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero p {
            font-size: 1.25rem;
            margin-bottom: 2rem;
            color: #e2e8f0;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .hero-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .features {
            background: white;
            padding: 5rem 2rem;
        }

        .features-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .features h2 {
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 3rem;
            color: #111827;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .feature-card {
            text-align: center;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background: #f8fafc;
            transition: transform 0.2s;
        }

        .feature-card:hover {
            transform: translateY(-4px);
        }

        .feature-icon {
            width: 4rem;
            height: 4rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
        }

        .feature-card h3 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #111827;
        }

        .feature-card p {
            color: #6b7280;
        }

        .cta {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            color: white;
            padding: 4rem 2rem;
            text-align: center;
        }

        .cta h2 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .cta p {
            font-size: 1.25rem;
            margin-bottom: 2rem;
            color: #e5e7eb;
        }

        /* Auth Styles */
        .auth-container {
            min-height: 100vh;
            background: linear-gradient(to bottom right, #dbeafe, #e0e7ff);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .auth-box {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            width: 100%;
            max-width: 28rem;
        }

        .auth-icon {
            width: 4rem;
            height: 4rem;
            background: #4f46e5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
        }

        .auth-title {
            font-size: 1.875rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .auth-subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .btn-secondary {
            background: transparent;
            color: #4f46e5;
            margin-top: 1rem;
            width: 100%;
        }

        .btn-secondary:hover {
            background: #eef2ff;
        }

        .btn-google {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
            margin-top: 1rem;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .btn-google:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .auth-divider {
            margin: 1.5rem 0;
            text-align: center;
            position: relative;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .auth-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e5e7eb;
        }

        .auth-divider span {
            background: white;
            padding: 0 1rem;
        }

        .back-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* App Styles */
        .header {
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 80rem;
            margin: 0 auto;
            padding: 1rem 1.5rem;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-email {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .btn-logout {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: #374151;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-logout:hover {
            background: #f3f4f6;
        }

        .nav-tabs {
            display: flex;
            gap: 0.25rem;
            border-bottom: 1px solid #e5e7eb;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: #6b7280;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
            white-space: nowrap;
        }

        .nav-tab:hover {
            color: #111827;
        }

        .nav-tab.active {
            color: #4f46e5;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #4f46e5;
        }

        .main-content {
            max-width: 80rem;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .stat-card {
            display: flex;
            flex-direction: column;
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
        }

        .stat-value {
            font-size: 1.875rem;
            font-weight: bold;
        }

        .transaction-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-radius: 0.5rem;
            transition: background 0.2s;
            border: 1px solid transparent;
        }

        .transaction-item:hover {
            background: #f9fafb;
        }

        .transaction-item.editing {
            background: #f0f9ff;
            border-color: #0ea5e9;
        }

        .transaction-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .transaction-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .transaction-icon.income {
            background: #dcfce7;
            color: #16a34a;
        }

        .transaction-icon.expense {
            background: #fee2e2;
            color: #dc2626;
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-details h4 {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .transaction-details p {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .transaction-amount {
            font-weight: 600;
            margin-right: 1rem;
        }

        .transaction-amount.income {
            color: #16a34a;
        }

        .transaction-amount.expense {
            color: #dc2626;
        }

        .transaction-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .transaction-item:hover .transaction-actions {
            opacity: 1;
        }

        .progress-bar {
            width: 100%;
            height: 0.5rem;
            background: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .progress-fill.green {
            background: #22c55e;
        }

        .progress-fill.yellow {
            background: #eab308;
        }

        .progress-fill.red {
            background: #ef4444;
        }

        .btn-add {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-add:hover {
            background: #4338ca;
        }

        .btn-edit {
            background: #0ea5e9;
            color: white;
            border: none;
            border-radius: 0.375rem;
            width: 32px;
            height: 32px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .btn-edit:hover {
            background: #0284c7;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 0.375rem;
            width: 32px;
            height: 32px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            line-height: 1;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-cancel {
            background: #6b7280;
            color: white;
        }

        .btn-cancel:hover {
            background: #4b5563;
        }

        .form-inline {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-row > * {
            flex: 1;
        }

        .hidden {
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }

        .budget-card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        .budget-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .budget-title {
            font-size: 1.25rem;
            font-weight: bold;
        }

        .budget-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .budget-badge.green {
            background: #dcfce7;
            color: #166534;
        }

        .budget-badge.yellow {
            background: #fef3c7;
            color: #854d0e;
        }

        .budget-badge.red {
            background: #fee2e2;
            color: #991b1b;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .analytics-stat {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        .analytics-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .analytics-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .add-form {
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
        }

        .account-card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        .filters-bar {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .search-box {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-box input {
            padding-left: 2.5rem;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }

        .goal-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .goal-progress {
            margin-top: 1rem;
        }

        .goal-progress-bar {
            background: rgba(255, 255, 255, 0.2);
            height: 0.75rem;
            border-radius: 9999px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .goal-progress-fill {
            background: white;
            height: 100%;
            transition: width 0.3s;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 0.75rem;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab.active {
            color: #4f46e5;
            border-bottom: 2px solid #4f46e5;
        }

        .chart-container {
            height: 300px;
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 0.5rem;
        }

        .chart-bar {
            background: #4f46e5;
            border-radius: 0.25rem 0.25rem 0 0;
            min-width: 40px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.25rem;
            transition: all 0.2s;
        }

        .chart-bar:hover {
            background: #4338ca;
            transform: scale(1.05);
        }

        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            max-width: 400px;
        }

        .notification.success {
            border-left: 4px solid #10b981;
        }

        .notification.error {
            border-left: 4px solid #ef4444;
        }

        .notification.info {
            border-left: 4px solid #3b82f6;
        }

        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2.5rem;
            }
            
            .nav {
                padding: 1rem;
            }
            
            .nav-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .hero-buttons {
                flex-direction: column;
                align-items: center;
            }

            .form-inline {
                grid-template-columns: 1fr;
            }

            .form-row {
                flex-direction: column;
            }

            .nav-tabs {
                padding-bottom: 0;
            }

            .main-content {
                padding: 1rem;
            }

            .grid-3, .grid-2, .grid-4 {
                grid-template-columns: 1fr;
            }

            .transaction-info {
                gap: 0.5rem;
            }

            .transaction-details h4 {
                font-size: 0.875rem;
            }

            .modal-content {
                width: 95%;
                padding: 1.5rem;
            }
        }

        /* Dark theme support */
        @media (prefers-color-scheme: dark) {
            body {
                background: #111827;
                color: #f9fafb;
            }

            .card, .modal-content {
                background: #1f2937;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            }

            .header {
                background: #1f2937;
            }

            input, select, textarea {
                background: #374151;
                border-color: #4b5563;
                color: #f9fafb;
            }

            .add-form {
                background: #374151;
                border-color: #4b5563;
            }

            .chart-container {
                background: #374151;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, query, orderBy, doc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAuEIYAHBHpzRtXpNk6WDrhy_0qY5biihQ",
            authDomain: "finance-d472d.firebaseapp.com",
            projectId: "finance-d472d",
            storageBucket: "finance-d472d.firebasestorage.app",
            messagingSenderId: "145145132834",
            appId: "1:145145132834:web:58827678d3c5d4d5d2977b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        let currentUser = null;
        let activeTab = 'dashboard';
        let transactions = [];
        let budgets = [
            { id: 1, category: 'Groceries', limit: 500, spent: 0 },
            { id: 2, category: 'Entertainment', limit: 200, spent: 0 },
            { id: 3, category: 'Transportation', limit: 300, spent: 0 },
            { id: 4, category: 'Utilities', limit: 400, spent: 0 },
            { id: 5, category: 'Healthcare', limit: 300, spent: 0 }
        ];
        let accounts = [];
        let goals = [];
        let lifeGoals = [];
        let currentPage = 'home';
        let isSignup = false;
        let editingTransaction = null;
        let searchTerm = '';
        let filterCategory = '';
        let filterType = '';
        let recurringTransactions = [];
        let bills = [];
        let userSettings = {
            currency: 'USD',
            dateFormat: 'MM/DD/YYYY',
            theme: 'light',
            notifications: true
        };

        // Enhanced categories
        const categories = [
            'Groceries', 'Entertainment', 'Transportation', 'Utilities', 'Healthcare',
            'Shopping', 'Dining', 'Travel', 'Education', 'Insurance', 'Investment',
            'Rent/Mortgage', 'Income', 'Gift', 'Other'
        ];

        // Data persistence functions
        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        function loadFromLocalStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                return null;
            }
        }

        // Enhanced data loading
        async function loadUserData() {
            if (!currentUser) return;
            try {
                const txQuery = query(collection(db, 'users', currentUser.uid, 'transactions'), orderBy('createdAt', 'desc'));
                const txSnapshot = await getDocs(txQuery);
                transactions = txSnapshot.docs.map(function(d) { return { id: d.id, ...d.data() }; });

                const budgetSnapshot = await getDocs(collection(db, 'users', currentUser.uid, 'budgets'));
                if (budgetSnapshot.docs.length > 0) {
                    budgets = budgetSnapshot.docs.map(function(d) { return { id: d.id, ...d.data() }; });
                }

                const accSnapshot = await getDocs(collection(db, 'users', currentUser.uid, 'accounts'));
                accounts = accSnapshot.docs.map(function(d) { return { id: d.id, ...d.data() }; });

                const goalSnapshot = await getDocs(collection(db, 'users', currentUser.uid, 'goals'));
                goals = goalSnapshot.docs.map(function(d) { return { id: d.id, ...d.data() }; });

                const lifeGoalSnapshot = await getDocs(collection(db, 'users', currentUser.uid, 'lifeGoals'));
                lifeGoals = lifeGoalSnapshot.docs.map(function(d) { return { id: d.id, ...d.data() }; });

                const billSnapshot = await getDocs(collection(db, 'users', currentUser.uid, 'bills'));
                bills = billSnapshot.docs.map(function(d) { return { id: d.id, ...d.data() }; });

                // Calculate budget spent amounts
                updateBudgetSpent();

            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Error loading data: ' + error.message, 'error');
            }
        }

        function updateBudgetSpent() {
            budgets.forEach(budget => {
                const spent = transactions
                    .filter(tx => tx.category === budget.category && tx.type === 'expense')
                    .reduce((sum, tx) => sum + Math.abs(tx.amount), 0);
                budget.spent = spent;
            });
        }

        // Enhanced transaction management
        async function saveTransaction(desc, amount, category, type, date = null) {
            if (!currentUser) return;
            try {
                var tx = {
                    date: date || new Date().toISOString().split('T')[0],
                    description: desc,
                    amount: parseFloat(amount) * (type === 'expense' ? -1 : 1),
                    category: category,
                    type: type,
                    createdAt: new Date()
                };
                await addDoc(collection(db, 'users', currentUser.uid, 'transactions'), tx);
                await loadUserData();
                showNotification('Transaction added successfully!', 'success');
                render();
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        async function updateTransaction(id, desc, amount, category, type, date) {
            if (!currentUser) return;
            try {
                await updateDoc(doc(db, 'users', currentUser.uid, 'transactions', id), {
                    description: desc,
                    amount: parseFloat(amount) * (type === 'expense' ? -1 : 1),
                    category: category,
                    type: type,
                    date: date
                });
                await loadUserData();
                showNotification('Transaction updated successfully!', 'success');
                editingTransaction = null;
                render();
            } catch (error) {
                showNotification('Error updating transaction: ' + error.message, 'error');
            }
        }

        async function deleteTransaction(id) {
            if (!currentUser || !confirm('Are you sure you want to delete this transaction?')) return;
            try {
                await deleteDoc(doc(db, 'users', currentUser.uid, 'transactions', id));
                await loadUserData();
                showNotification('Transaction deleted successfully!', 'success');
                render();
            } catch (error) {
                showNotification('Error deleting transaction: ' + error.message, 'error');
            }
        }

        // Goal management
        async function saveGoal(name, targetAmount, currentAmount = 0, targetDate = null) {
            if (!currentUser) return;
            try {
                const goal = {
                    name: name,
                    targetAmount: parseFloat(targetAmount),
                    currentAmount: parseFloat(currentAmount),
                    targetDate: targetDate,
                    createdAt: new Date()
                };
                await addDoc(collection(db, 'users', currentUser.uid, 'goals'), goal);
                await loadUserData();
                showNotification('Goal created successfully!', 'success');
                render();
            } catch (error) {
                showNotification('Error creating goal: ' + error.message, 'error');
            }
        }

        // Life Goal management
        async function saveLifeGoal(name, category, description, targetDate, priority = 'medium') {
            if (!currentUser) return;
            try {
                const lifeGoal = {
                    name: name,
                    category: category,
                    description: description,
                    targetDate: targetDate,
                    priority: priority,
                    status: 'not-started',
                    progress: 0,
                    milestones: [],
                    createdAt: new Date(),
                    completedAt: null
                };
                await addDoc(collection(db, 'users', currentUser.uid, 'lifeGoals'), lifeGoal);
                await loadUserData();
                showNotification('Life goal created successfully!', 'success');
                render();
            } catch (error) {
                showNotification('Error creating life goal: ' + error.message, 'error');
            }
        }

        async function updateLifeGoalStatus(id, status) {
            if (!currentUser) return;
            try {
                await updateDoc(doc(db, 'users', currentUser.uid, 'lifeGoals', id), {
                    status: status,
                    completedAt: status === 'completed' ? new Date() : null
                });
                await loadUserData();
                showNotification('Life goal status updated!', 'success');
                render();
            } catch (error) {
                showNotification('Error updating life goal: ' + error.message, 'error');
            }
        }

        async function addMilestone(goalId, milestoneName, dueDate) {
            if (!currentUser) return;
            try {
                const goal = lifeGoals.find(g => g.id === goalId);
                if (!goal) return;
                
                const newMilestone = {
                    id: Date.now().toString(),
                    name: milestoneName,
                    dueDate: dueDate,
                    completed: false,
                    createdAt: new Date()
                };
                
                const updatedMilestones = [...(goal.milestones || []), newMilestone];
                await updateDoc(doc(db, 'users', currentUser.uid, 'lifeGoals', goalId), {
                    milestones: updatedMilestones
                });
                await loadUserData();
                showNotification('Milestone added!', 'success');
                render();
            } catch (error) {
                showNotification('Error adding milestone: ' + error.message, 'error');
            }
        }

        async function deleteLifeGoal(id) {
            if (!currentUser || !confirm('Are you sure you want to delete this life goal?')) return;
            try {
                await deleteDoc(doc(db, 'users', currentUser.uid, 'lifeGoals', id));
                await loadUserData();
                showNotification('Life goal deleted successfully!', 'success');
                render();
            } catch (error) {
                showNotification('Error deleting life goal: ' + error.message, 'error');
            }
        }

        async function updateGoalProgress(id, amount) {
            if (!currentUser) return;
            try {
                const goal = goals.find(g => g.id === id);
                if (!goal) return;
                
                await updateDoc(doc(db, 'users', currentUser.uid, 'goals', id), {
                    currentAmount: parseFloat(amount)
                });
                await loadUserData();
                showNotification('Goal updated successfully!', 'success');
                render();
            } catch (error) {
                showNotification('Error updating goal: ' + error.message, 'error');
            }
        }

        // Budget management
        async function saveBudget(category, limit) {
            if (!currentUser) return;
            try {
                const existingBudget = budgets.find(b => b.category === category);
                if (existingBudget) {
                    await updateDoc(doc(db, 'users', currentUser.uid, 'budgets', existingBudget.id), {
                        limit: parseFloat(limit)
                    });
                } else {
                    await addDoc(collection(db, 'users', currentUser.uid, 'budgets'), {
                        category: category,
                        limit: parseFloat(limit),
                        spent: 0,
                        createdAt: new Date()
                    });
                }
                await loadUserData();
                showNotification('Budget saved successfully!', 'success');
                render();
            } catch (error) {
                showNotification('Error saving budget: ' + error.message, 'error');
            }
        }

        // Bill reminders
        async function saveBill(name, amount, dueDate, recurring = false) {
            if (!currentUser) return;
            try {
                const bill = {
                    name: name,
                    amount: parseFloat(amount),
                    dueDate: dueDate,
                    recurring: recurring,
                    paid: false,
                    createdAt: new Date()
                };
                await addDoc(collection(db, 'users', currentUser.uid, 'bills'), bill);
                await loadUserData();
                showNotification('Bill reminder created!', 'success');
                render();
            } catch (error) {
                showNotification('Error creating bill reminder: ' + error.message, 'error');
            }
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <strong>${type === 'success' ? 'Success!' : type === 'error' ? 'Error!' : 'Info'}</strong>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem;">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.25rem; cursor: pointer; color: #6b7280;">&times;</button>
                </div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Plaid Link Integration (keeping existing functions)
        let plaidHandler = null;

        async function initPlaidLink() {
            if (!currentUser) return;
            
            try {
                const response = await fetch('https://us-central1-finance-d472d.cloudfunctions.net/createLinkToken', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUser.uid
                    })
                });

                const data = await response.json();
                
                if (data.link_token) {
                    plaidHandler = Plaid.create({
                        token: data.link_token,
                        onSuccess: async function(public_token, metadata) {
                            console.log('Plaid Link successful!', metadata);
                            
                            const exchangeResponse = await fetch('https://us-central1-finance-d472d.cloudfunctions.net/exchangePublicToken', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    public_token: public_token,
                                    user_id: currentUser.uid
                                })
                            });

                            const exchangeData = await exchangeResponse.json();
                            
                            if (exchangeData.success) {
                                showNotification('Bank account connected successfully!', 'success');
                                await loadUserData();
                                await fetchPlaidTransactions();
                                render();
                            } else {
                                showNotification('Error connecting account: ' + exchangeData.error, 'error');
                            }
                        },
                        onLoad: function() {
                            console.log('Plaid Link loaded');
                        },
                        onExit: function(err, metadata) {
                            console.log('Plaid Link exited', err, metadata);
                        },
                        onEvent: function(eventName, metadata) {
                            console.log('Plaid Link event', eventName, metadata);
                        },
                        env: 'sandbox',
                        product: ['transactions'],
                        clientName: 'DoughMain'
                    });
                } else {
                    showNotification('Error initializing bank connection: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error initializing Plaid Link:', error);
                showNotification('Error connecting to bank: ' + error.message, 'error');
            }
        }

        async function connectBankAccount() {
            if (plaidHandler) {
                plaidHandler.open();
            } else {
                await initPlaidLink();
                if (plaidHandler) {
                    plaidHandler.open();
                }
            }
        }

        async function fetchPlaidTransactions() {
            if (!currentUser) return;
            
            try {
                const response = await fetch('https://us-central1-finance-d472d.cloudfunctions.net/fetchTransactions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUser.uid,
                        start_date: '2024-01-01',
                        end_date: new Date().toISOString().split('T')[0]
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    console.log('Fetched ' + data.count + ' transactions from Plaid');
                    showNotification(`Imported ${data.count} transactions from your bank`, 'success');
                    await loadUserData();
                    render();
                } else {
                    console.error('Error fetching transactions:', data.error);
                }
            } catch (error) {
                console.error('Error fetching Plaid transactions:', error);
            }
        }

        async function updateAccountBalances() {
            if (!currentUser) return;
            
            try {
                const response = await fetch('https://us-central1-finance-d472d.cloudfunctions.net/updateBalances', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUser.uid
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    console.log('Account balances updated');
                    showNotification('Account balances updated successfully!', 'success');
                    await loadUserData();
                    render();
                } else {
                    console.error('Error updating balances:', data.error);
                }
            } catch (error) {
                console.error('Error updating account balances:', error);
            }
        }

        // Stats calculation
        function getStats() {
            var totalBalance = 0;
            for (var i = 0; i < accounts.length; i++) {
                totalBalance += accounts[i].balance || 0;
            }

            var currentMonth = new Date().toISOString().slice(0, 7);
            var monthlyIncome = 0;
            var monthlyExpenses = 0;

            for (var j = 0; j < transactions.length; j++) {
                if (transactions[j].date && transactions[j].date.startsWith(currentMonth)) {
                    if (transactions[j].type === 'income') {
                        monthlyIncome += Math.abs(transactions[j].amount || 0);
                    } else {
                        monthlyExpenses += Math.abs(transactions[j].amount || 0);
                    }
                }
            }

            var netWorth = totalBalance + transactions.reduce((sum, tx) => sum + (tx.amount || 0), 0);
            var savingsRate = monthlyIncome > 0 ? ((monthlyIncome - monthlyExpenses) / monthlyIncome) * 100 : 0;

            return { 
                totalBalance: totalBalance, 
                monthlyIncome: monthlyIncome, 
                monthlyExpenses: monthlyExpenses,
                netWorth: netWorth,
                savingsRate: savingsRate
            };
        }

        // Enhanced filtering and search
        function getFilteredTransactions() {
            let filtered = transactions;

            if (searchTerm) {
                filtered = filtered.filter(tx => 
                    (tx.description || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (tx.category || '').toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            if (filterCategory && filterCategory !== 'all') {
                filtered = filtered.filter(tx => tx.category === filterCategory);
            }

            if (filterType && filterType !== 'all') {
                filtered = filtered.filter(tx => tx.type === filterType);
            }

            return filtered;
        }

        // Data export functionality
        function exportTransactions() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "Date,Description,Amount,Category,Type\n" +
                transactions.map(tx => 
                    `${tx.date || ''},${tx.description || ''},${tx.amount || 0},${tx.category || ''},${tx.type || ''}`
                ).join('\n');

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `transactions-${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // UI Components
        function showHomepage() {
            return `
                <div class="homepage">
                    <nav class="nav">
                        <div class="nav-logo" style="cursor: pointer;" onclick="showHome()">
                            <svg width="32" height="32" fill="white" viewBox="0 0 24 24">
                                <path d="M19 14V6c0-1.1-.9-2-2-2H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zm-9-1c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm13-6v11c0 1.1-.9 2-2 2H4v-2h17V7h2z"/>
                            </svg>
                            DoughMain
                        </div>
                        <div class="nav-buttons">
                            <button class="btn btn-outline" onclick="showAuth(false)">Sign In</button>
                            <button class="btn btn-primary" onclick="showAuth(true)">Get Started</button>
                        </div>
                    </nav>

                    <section class="hero">
                        <h1>Transform Your Financial Future</h1>
                        <p style="font-size: 1.5rem; margin-bottom: 1rem; line-height: 1.4;">Your journey to financial freedom starts here. Track every dollar, crush your goals, and build the wealth you deserve.</p>
                        <p style="font-size: 1.125rem; margin-bottom: 2.5rem; opacity: 0.9;">Join thousands who've taken control of their finances with DoughMain - where smart money management meets beautiful design.</p>
                        <div class="hero-buttons">
                            <button class="btn btn-primary" onclick="showAuth(true)" style="font-size: 1.125rem; padding: 1rem 2rem;">Start Free Today</button>
                            <button class="btn btn-outline" onclick="showAuth(false)" style="font-size: 1.125rem; padding: 1rem 2rem;">Sign In</button>
                        </div>
                    </section>
                </div>

                <section class="features">
                    <div class="features-container">
                        <h2>Everything You Need to Manage Your Finances</h2>
                        <div class="features-grid">
                            <div class="feature-card">
                                <div class="feature-icon">
                                    <svg width="32" height="32" fill="white" viewBox="0 0 24 24">
                                        <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline>
                                        <polyline points="16 7 22 7 22 13"></polyline>
                                    </svg>
                                </div>
                                <h3>Advanced Transaction Tracking</h3>
                                <p>Monitor, edit, search, and categorize your spending with detailed transaction management and smart categorization.</p>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon">
                                    <svg width="32" height="32" fill="white" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                </div>
                                <h3>Smart Budget Management</h3>
                                <p>Set spending limits, track progress, get alerts, and receive personalized recommendations to stay on track.</p>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon">
                                    <svg width="32" height="32" fill="white" viewBox="0 0 24 24">
                                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                                        <rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect>
                                    </svg>
                                </div>
                                <h3>Goal Setting & Savings</h3>
                                <p>Set financial goals, track progress, and automate savings to achieve your dreams faster.</p>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon">
                                    <svg width="32" height="32" fill="white" viewBox="0 0 24 24">
                                        <rect width="20" height="14" x="2" y="5" rx="2"></rect>
                                        <line x1="2" x2="22" y1="10" y2="10"></line>
                                    </svg>
                                </div>
                                <h3>Bank Integration</h3>
                                <p>Connect your bank accounts securely to automatically sync transactions and balances with Plaid.</p>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon">
                                    <svg width="32" height="32" fill="white" viewBox="0 0 24 24">
                                        <path d="M3 3v18h18"></path>
                                        <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"></path>
                                    </svg>
                                </div>
                                <h3>Advanced Analytics</h3>
                                <p>Get detailed insights with charts, trends, spending analysis, and financial health reports.</p>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon">
                                    <svg width="32" height="32" fill="white" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="3"></circle>
                                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                    </svg>
                                </div>
                                <h3>Bill Reminders & Automation</h3>
                                <p>Never miss a payment with smart bill reminders, recurring transaction tracking, and automation tools.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="cta">
                    <h2>Ready to Transform Your Financial Life?</h2>
                    <p>Join thousands of users who have taken control of their finances with our comprehensive platform.</p>
                    <button class="btn btn-primary" onclick="showAuth(true)" style="font-size: 1.125rem; padding: 1rem 2rem;">Start Your Journey Today</button>
                </section>
            `;
        }

        function showAuthPage() {
            return `
                <button class="back-btn" onclick="showHome()">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Back to Home
                </button>
                <div class="auth-container">
                    <div class="auth-box">
                        <div class="auth-icon">
                            <svg width="32" height="32" fill="white" viewBox="0 0 24 24">
                                <path d="M21 18v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v1"></path>
                                <polyline points="15 10 20 15 15 20"></polyline>
                                <line x1="4" x2="20" y1="15" y2="15"></line>
                            </svg>
                        </div>
                        <h1 class="auth-title">DoughMain</h1>
                        <p class="auth-subtitle">Manage your money with ease</p>
                        
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="email" placeholder="you@example.com">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="password" placeholder="">
                        </div>
                        <button class="btn btn-primary" onclick="handleAuth()">${isSignup ? 'Create Account' : 'Sign In'}</button>
                        
                        <div class="auth-divider">
                            <span>or</span>
                        </div>
                        
                        <button class="btn btn-google" onclick="handleGoogleSignIn()">
                            <svg width="18" height="18" viewBox="0 0 24 24">
                                <path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Continue with Google
                        </button>
                        
                        <button class="btn btn-secondary" onclick="toggleAuth()">${isSignup ? 'Already have an account? Sign in' : "Don't have an account? Sign up"}</button>
                    </div>
                </div>
            `;
        }

        // Authentication functions
        function showAuth(signup = false) {
            currentPage = 'auth';
            isSignup = signup;
            render();
        }

        function showHome() {
            currentPage = 'home';
            render();
        }

        function toggleAuth() {
            isSignup = !isSignup;
            render();
        }

        function handleAuth() {
            var email = document.getElementById('email').value.trim();
            var password = document.getElementById('password').value;
            if (!email || !password) { 
                showNotification('Please fill in all fields', 'error');
                return; 
            }
            
            if (isSignup) {
                createUserWithEmailAndPassword(auth, email, password)
                    .then(function(result) {
                        return setDoc(doc(db, 'users', result.user.uid), { email: email, createdAt: new Date() });
                    })
                    .catch(function(error) {
                        showNotification('Signup failed: ' + error.message, 'error');
                    });
            } else {
                signInWithEmailAndPassword(auth, email, password)
                    .catch(function(error) {
                        showNotification('Login failed: ' + error.message, 'error');
                    });
            }
        }

        function handleGoogleSignIn() {
            signInWithPopup(auth, googleProvider)
                .then(function(result) {
                    var user = result.user;
                    return setDoc(doc(db, 'users', user.uid), {
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        lastSignIn: new Date()
                    }, { merge: true });
                })
                .catch(function(error) {
                    console.error('Google sign-in error:', error);
                    showNotification('Google sign-in failed: ' + error.message, 'error');
                });
        }

        // Main render function
        function render() {
            var appEl = document.getElementById('app');
            
            if (currentUser) {
                var stats = getStats();
                var content = '';
                
                if (activeTab === 'dashboard') {
                    // Dashboard content
                    var txList = '';
                    var filteredTx = getFilteredTransactions();
                    var limit = Math.min(5, filteredTx.length);
                    for (var i = 0; i < limit; i++) {
                        var t = filteredTx[i];
                        var amt = t.amount || 0;
                        var icon = t.type === 'income' ? '' : '';
                        txList += `<div class="transaction-item">
                            <div class="transaction-info">
                                <div class="transaction-icon ${t.type}">${icon}</div>
                                <div class="transaction-details">
                                    <h4>${t.description || 'Unknown'}</h4>
                                    <p>${t.date || ''}  ${t.category || ''}</p>
                                </div>
                            </div>
                            <div class="transaction-amount ${t.type}">$${Math.abs(amt).toFixed(2)}</div>
                        </div>`;
                    }
                    if (filteredTx.length === 0) {
                        txList = '<div class="empty-state"><h3>No transactions yet</h3><p>Add your first transaction to get started</p></div>';
                    }
                    
                    // Goals section
                    var goalsList = '';
                    for (var g = 0; g < Math.min(3, goals.length); g++) {
                        var goal = goals[g];
                        var progress = goal.targetAmount > 0 ? (goal.currentAmount / goal.targetAmount) * 100 : 0;
                        goalsList += `<div class="goal-card">
                            <h3>${goal.name}</h3>
                            <p>$${goal.currentAmount.toFixed(2)} of $${goal.targetAmount.toFixed(2)}</p>
                            <div class="goal-progress">
                                <div class="goal-progress-bar">
                                    <div class="goal-progress-fill" style="width: ${Math.min(progress, 100)}%"></div>
                                </div>
                                <small>${progress.toFixed(1)}% complete</small>
                            </div>
                        </div>`;
                    }
                    
                    content = `<div class="grid grid-4">
                        <div class="card stat-card">
                            <div class="stat-header"><span class="stat-label">Total Balance</span></div>
                            <div class="stat-value">$${stats.totalBalance.toFixed(2)}</div>
                        </div>
                        <div class="card stat-card">
                            <div class="stat-header"><span class="stat-label">Monthly Income</span></div>
                            <div class="stat-value" style="color:#16a34a">$${stats.monthlyIncome.toFixed(2)}</div>
                        </div>
                        <div class="card stat-card">
                            <div class="stat-header"><span class="stat-label">Monthly Expenses</span></div>
                            <div class="stat-value" style="color:#dc2626">$${stats.monthlyExpenses.toFixed(2)}</div>
                        </div>
                        <div class="card stat-card">
                            <div class="stat-header"><span class="stat-label">Savings Rate</span></div>
                            <div class="stat-value" style="color:${stats.savingsRate >= 20 ? '#16a34a' : stats.savingsRate >= 10 ? '#eab308' : '#dc2626'}">${stats.savingsRate.toFixed(1)}%</div>
                        </div>
                    </div>
                    ${goalsList}
                    <div class="grid grid-2">
                        <div class="card">
                            <h2 style="font-size:1.25rem;font-weight:bold;margin-bottom:1rem">Recent Transactions</h2>
                            ${txList}
                        </div>
                        <div class="card">
                            <h2 style="font-size:1.25rem;font-weight:bold;margin-bottom:1rem">Quick Actions</h2>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <button class="btn btn-add" onclick="switchTab('transactions')">Add Transaction</button>
                                <button class="btn btn-primary" onclick="connectBankAccount()">Connect Bank</button>
                                <button class="btn btn-primary" onclick="switchTab('goals')">Set Goal</button>
                                <button class="btn btn-primary" onclick="exportTransactions()">Export Data</button>
                            </div>
                        </div>
                    </div>`;

                } else if (activeTab === 'transactions') {
                    var filteredTx = getFilteredTransactions();
                    var txItems = '';
                    
                    for (var k = 0; k < filteredTx.length; k++) {
                        var tx = filteredTx[k];
                        var txAmt = tx.amount || 0;
                        var isEditing = editingTransaction === tx.id;
                        var icon = tx.type === 'income' ? '' : '';
                        
                        if (isEditing) {
                            txItems += `<div class="transaction-item editing">
                                <div class="transaction-info" style="flex-direction: column; gap: 0.5rem;">
                                    <div class="form-row">
                                        <input type="text" id="editDesc" value="${tx.description || ''}" placeholder="Description">
                                        <input type="number" id="editAmount" value="${Math.abs(txAmt)}" step="0.01" placeholder="Amount">
                                    </div>
                                    <div class="form-row">
                                        <select id="editCategory">${categories.map(cat => `<option value="${cat}" ${cat === tx.category ? 'selected' : ''}>${cat}</option>`).join('')}</select>
                                        <select id="editType">
                                            <option value="expense" ${tx.type === 'expense' ? 'selected' : ''}>Expense</option>
                                            <option value="income" ${tx.type === 'income' ? 'selected' : ''}>Income</option>
                                        </select>
                                        <input type="date" id="editDate" value="${tx.date || ''}">
                                    </div>
                                    <div class="form-row">
                                        <button class="btn btn-success btn-small" onclick="saveEditTransaction('${tx.id}')">Save</button>
                                        <button class="btn btn-cancel btn-small" onclick="cancelEditTransaction()">Cancel</button>
                                    </div>
                                </div>
                            </div>`;
                        } else {
                            txItems += `<div class="transaction-item">
                                <div class="transaction-info">
                                    <div class="transaction-icon ${tx.type}">${icon}</div>
                                    <div class="transaction-details">
                                        <h4>${tx.description || 'Unknown'}</h4>
                                        <p>${tx.date || ''}  ${tx.category || ''}</p>
                                    </div>
                                </div>
                                <div class="transaction-amount ${tx.type}">$${Math.abs(txAmt).toFixed(2)}</div>
                                <div class="transaction-actions">
                                    <button class="btn-edit" onclick="editTransaction('${tx.id}')" title="Edit"></button>
                                    <button class="btn-delete" onclick="deleteTransaction('${tx.id}')" title="Delete"></button>
                                </div>
                            </div>`;
                        }
                    }
                    
                    if (filteredTx.length === 0) {
                        txItems = '<div class="empty-state"><h3>No transactions found</h3><p>Try adjusting your filters or add a new transaction</p></div>';
                    }
                    
                    content = `<div class="filters-bar">
                        <div class="form-inline">
                            <div class="search-box">
                                <input type="text" placeholder="Search transactions..." value="${searchTerm}" oninput="updateSearch(this.value)">
                                <span class="search-icon"></span>
                            </div>
                            <select onchange="updateFilter('category', this.value)" value="${filterCategory}">
                                <option value="">All Categories</option>
                                ${categories.map(cat => `<option value="${cat}" ${cat === filterCategory ? 'selected' : ''}>${cat}</option>`).join('')}
                            </select>
                            <select onchange="updateFilter('type', this.value)" value="${filterType}">
                                <option value="">All Types</option>
                                <option value="income" ${filterType === 'income' ? 'selected' : ''}>Income</option>
                                <option value="expense" ${filterType === 'expense' ? 'selected' : ''}>Expense</option>
                            </select>
                            <button class="btn btn-primary" onclick="exportTransactions()">Export CSV</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="section-header">
                            <h2 class="section-title">Transactions (${filteredTx.length})</h2>
                            <button class="btn-add" onclick="document.getElementById('txForm').classList.toggle('hidden');">+ Add Transaction</button>
                        </div>
                        <div id="txForm" class="add-form hidden">
                            <div class="form-inline">
                                <input type="text" id="txDesc" placeholder="Description">
                                <input type="number" id="txAmount" placeholder="Amount" step="0.01">
                                <select id="txCategory">${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}</select>
                                <select id="txType">
                                    <option value="expense">Expense</option>
                                    <option value="income">Income</option>
                                </select>
                                <input type="date" id="txDate" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <button class="btn btn-primary" onclick="addTransaction()">Add Transaction</button>
                        </div>
                        ${txItems}
                    </div>`;

                } else if (activeTab === 'budgets') {
                    var budgetCards = '';
                    for (var m = 0; m < budgets.length; m++) {
                        var bg = budgets[m];
                        var bgPct = ((bg.spent || 0) / (bg.limit || 1)) * 100;
                        var bgColor = bgPct > 90 ? 'red' : bgPct > 70 ? 'yellow' : 'green';
                        var remaining = (bg.limit || 0) - (bg.spent || 0);
                        budgetCards += `<div class="budget-card">
                            <div class="budget-header">
                                <h3 class="budget-title">${bg.category}</h3>
                                <span class="budget-badge ${bgColor}">${bgPct.toFixed(0)}%</span>
                            </div>
                            <div style="margin-bottom:1rem">
                                <div style="display:flex;justify-content:space-between;font-size:0.875rem;color:#6b7280;margin-bottom:0.5rem">
                                    <span>$${(bg.spent || 0).toFixed(2)}</span>
                                    <span>$${(bg.limit || 0).toFixed(2)}</span>
                                </div>
                                <div class="progress-bar" style="height:0.75rem">
                                    <div class="progress-fill ${bgColor}" style="width:${Math.min(bgPct, 100)}%"></div>
                                </div>
                            </div>
                            <div style="padding-top:1rem;border-top:1px solid #e5e7eb;font-size:0.875rem">
                                Remaining: <strong style="color:${remaining >= 0 ? '#16a34a' : '#dc2626'}">$${remaining.toFixed(2)}</strong>
                            </div>
                        </div>`;
                    }
                    
                    content = `<div class="section-header">
                        <h2 class="section-title">Budget Management</h2>
                        <button class="btn-add" onclick="document.getElementById('budgetForm').classList.toggle('hidden');">+ Add Budget</button>
                    </div>
                    <div id="budgetForm" class="add-form hidden">
                        <div class="form-inline">
                            <select id="budgetCategory">${categories.filter(cat => cat !== 'Income').map(cat => `<option value="${cat}">${cat}</option>`).join('')}</select>
                            <input type="number" id="budgetLimit" placeholder="Monthly Limit" step="0.01">
                        </div>
                        <button class="btn btn-primary" onclick="addBudget()">Add Budget</button>
                    </div>
                    <div class="grid grid-2">${budgetCards}</div>`;

                } else if (activeTab === 'goals') {
                    var goalCards = '';
                    for (var g = 0; g < goals.length; g++) {
                        var goal = goals[g];
                        var progress = goal.targetAmount > 0 ? (goal.currentAmount / goal.targetAmount) * 100 : 0;
                        var remaining = goal.targetAmount - goal.currentAmount;
                        goalCards += `<div class="goal-card">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <h3>${goal.name}</h3>
                                <button class="btn-delete" onclick="deleteGoal('${goal.id}')" style="background: rgba(255,255,255,0.2);"></button>
                            </div>
                            <p style="margin: 0.5rem 0;">$${goal.currentAmount.toFixed(2)} of $${goal.targetAmount.toFixed(2)}</p>
                            ${goal.targetDate ? `<p style="font-size: 0.875rem; opacity: 0.8;">Target: ${goal.targetDate}</p>` : ''}
                            <div class="goal-progress">
                                <div class="goal-progress-bar">
                                    <div class="goal-progress-fill" style="width: ${Math.min(progress, 100)}%"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.875rem;">
                                    <span>${progress.toFixed(1)}% complete</span>
                                    <span>$${remaining.toFixed(2)} remaining</span>
                                </div>
                                <div style="margin-top: 0.5rem;">
                                    <input type="number" id="goalProgress-${goal.id}" placeholder="Add amount" step="0.01" style="width: 60%; margin-right: 0.5rem;">
                                    <button class="btn btn-small" onclick="updateGoalProgress('${goal.id}', document.getElementById('goalProgress-${goal.id}').value)">Update</button>
                                </div>
                            </div>
                        </div>`;
                    }
                    
                    content = `<div class="section-header">
                        <h2 class="section-title">Financial Goals</h2>
                        <button class="btn-add" onclick="document.getElementById('goalForm').classList.toggle('hidden');">+ Add Goal</button>
                    </div>
                    <div id="goalForm" class="add-form hidden">
                        <div class="form-inline">
                            <input type="text" id="goalName" placeholder="Goal Name (e.g., Emergency Fund)">
                            <input type="number" id="goalTarget" placeholder="Target Amount" step="0.01">
                            <input type="number" id="goalCurrent" placeholder="Current Amount" step="0.01" value="0">
                            <input type="date" id="goalDate" placeholder="Target Date">
                        </div>
                        <button class="btn btn-primary" onclick="addGoal()">Add Goal</button>
                    </div>
                    <div class="grid grid-2">${goalCards || '<div class="empty-state"><h3>No goals set</h3><p>Create your first financial goal to start saving</p></div>'}</div>`;

                } else if (activeTab === 'accounts') {
                    var accCards = '';
                    for (var n = 0; n < accounts.length; n++) {
                        var ac = accounts[n];
                        accCards += `<div class="account-card">
                            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.5rem">
                                <h3 style="font-weight:600;margin:0">${ac.name || 'Account'}</h3>
                                <button class="btn-delete" onclick="deleteAccount('${ac.account_id || ac.id}')" title="Delete Account"></button>
                            </div>
                            <p style="font-size:0.75rem;color:#6b7280;text-transform:uppercase;margin-bottom:0.5rem">${ac.type || ''}  ${ac.subtype || ''}</p>
                            <p style="font-size:1.875rem;font-weight:bold;color:#4f46e5">$${(ac.balance || 0).toFixed(2)}</p>
                            ${ac.available ? `<p style="font-size:0.875rem;color:#6b7280;margin-top:0.25rem">Available: $${ac.available.toFixed(2)}</p>` : ''}
                        </div>`;
                    }
                    
                    content = `<div class="section-header">
                        <h2 class="section-title">Connected Accounts</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary btn-small" onclick="updateAccountBalances()">Refresh Balances</button>
                            <button class="btn-add" onclick="connectBankAccount()">+ Connect Account</button>
                        </div>
                    </div>
                    ${accounts.length === 0 ? '<div class="card empty-state"><h3>No accounts connected</h3><p>Connect your bank account with Plaid to automatically sync transactions and balances</p><button class="btn btn-primary" onclick="connectBankAccount()">Connect Your First Account</button></div>' : '<div class="grid grid-3">' + accCards + '</div>'}`;

                } else if (activeTab === 'analytics') {
                    var totalSpent = 0;
                    for (var p = 0; p < budgets.length; p++) {
                        totalSpent += budgets[p].spent || 0;
                    }
                    if (totalSpent === 0) totalSpent = 1;
                    
                    var catList = '';
                    for (var q = 0; q < budgets.length; q++) {
                        var catPct = ((budgets[q].spent || 0) / totalSpent) * 100;
                        if (budgets[q].spent > 0) {
                            catList += `<div style="margin-bottom:1rem">
                                <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem">
                                    <span>${budgets[q].category}</span>
                                    <span style="font-weight:600">$${budgets[q].spent.toFixed(2)} (${catPct.toFixed(1)}%)</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="background:#4f46e5;width:${catPct}%"></div>
                                </div>
                            </div>`;
                        }
                    }
                    
                    var expenseCount = transactions.filter(tx => tx.type === 'expense').length;
                    var avgTx = expenseCount > 0 ? stats.monthlyExpenses / expenseCount : 0;
                    var netCash = stats.monthlyIncome - stats.monthlyExpenses;
                    
                    // Monthly trend chart (simplified)
                    var monthlyData = {};
                    transactions.forEach(tx => {
                        var month = tx.date ? tx.date.slice(0, 7) : '';
                        if (month && tx.type === 'expense') {
                            monthlyData[month] = (monthlyData[month] || 0) + Math.abs(tx.amount);
                        }
                    });
                    
                    content = `<div class="card">
                        <h2 class="section-title" style="margin-bottom:1.5rem">Spending Analysis</h2>
                        ${catList || '<p>No spending data available</p>'}
                    </div>
                    <div class="grid grid-3" style="margin-top:1.5rem">
                        <div class="analytics-stat">
                            <h3 class="analytics-label">Average Transaction</h3>
                            <p class="analytics-value">$${avgTx.toFixed(2)}</p>
                        </div>
                        <div class="analytics-stat">
                            <h3 class="analytics-label">Total Transactions</h3>
                            <p class="analytics-value">${transactions.length}</p>
                        </div>
                        <div class="analytics-stat">
                            <h3 class="analytics-label">Net Cash Flow</h3>
                            <p class="analytics-value" style="color:${netCash >= 0 ? '#16a34a' : '#dc2626'}">$${netCash.toFixed(2)}</p>
                        </div>
                    </div>`;
                
                } else if (activeTab === 'lifeGoals') {
                    var lifeGoalCards = '';
                    var lifeGoalCategories = ['Career', 'Health & Fitness', 'Learning', 'Personal', 'Family', 'Travel', 'Creative', 'Financial'];
                    var categoryColors = {
                        'Career': '#8b5cf6',
                        'Health & Fitness': '#10b981',
                        'Learning': '#3b82f6',
                        'Personal': '#f59e0b',
                        'Family': '#ec4899',
                        'Travel': '#06b6d4',
                        'Creative': '#f97316',
                        'Financial': '#6366f1'
                    };
                    
                    for (var lg = 0; lg < lifeGoals.length; lg++) {
                        var lg_item = lifeGoals[lg];
                        var color = categoryColors[lg_item.category] || '#6b7280';
                        var completedMilestones = (lg_item.milestones || []).filter(m => m.completed).length;
                        var totalMilestones = (lg_item.milestones || []).length;
                        var milestonePct = totalMilestones > 0 ? (completedMilestones / totalMilestones) * 100 : 0;
                        var statusColor = lg_item.status === 'completed' ? '#10b981' : lg_item.status === 'in-progress' ? '#f59e0b' : '#9ca3af';
                        var daysLeft = lg_item.targetDate ? Math.ceil((new Date(lg_item.targetDate) - new Date()) / (1000 * 3600 * 24)) : null;
                        
                        lifeGoalCards += `<div class="card" style="border-left: 4px solid ${color}; position: relative;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <div>
                                    <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 0.25rem;">${lg_item.name}</h3>
                                    <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">${lg_item.category}</p>
                                </div>
                                <button class="btn-delete" onclick="deleteLifeGoal('${lg_item.id}')" title="Delete Goal" style="position: absolute; top: 1rem; right: 1rem;"></button>
                            </div>
                            ${lg_item.description ? `<p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem;">${lg_item.description}</p>` : ''}
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.75rem; padding: 0.25rem 0.75rem; border-radius: 9999px; background: ${statusColor}; color: white; font-weight: 500;">
                                        ${lg_item.status.replace('-', ' ').toUpperCase()}
                                    </span>
                                    <span style="font-size: 0.75rem; padding: 0.25rem 0.75rem; border-radius: 9999px; background: ${lg_item.priority === 'high' ? '#ef4444' : lg_item.priority === 'medium' ? '#f59e0b' : '#10b981'}; color: white; font-weight: 500;">
                                        ${lg_item.priority.toUpperCase()} PRIORITY
                                    </span>
                                </div>
                            </div>
                            ${lg_item.targetDate ? `<p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem;"> Target: ${lg_item.targetDate}${daysLeft ? ` (${daysLeft > 0 ? daysLeft + ' days left' : 'Overdue by ' + Math.abs(daysLeft) + ' days'})` : ''}</p>` : ''}
                            ${totalMilestones > 0 ? `
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Milestones: ${completedMilestones}/${totalMilestones}</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="background: ${color}; width: ${milestonePct}%"></div>
                                    </div>
                                </div>
                            ` : ''}
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <select onchange="updateLifeGoalStatus('${lg_item.id}', this.value)" style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    <option value="not-started" ${lg_item.status === 'not-started' ? 'selected' : ''}>Not Started</option>
                                    <option value="in-progress" ${lg_item.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="paused" ${lg_item.status === 'paused' ? 'selected' : ''}>Paused</option>
                                    <option value="completed" ${lg_item.status === 'completed' ? 'selected' : ''}>Completed</option>
                                </select>
                            </div>
                        </div>`;
                    }
                    
                    content = `<div class="section-header">
                        <h2 class="section-title">Life Goals</h2>
                        <button class="btn-add" onclick="document.getElementById('lifeGoalForm').classList.toggle('hidden');">+ Add Life Goal</button>
                    </div>
                    <div id="lifeGoalForm" class="add-form hidden">
                        <div class="form-inline">
                            <input type="text" id="lifeGoalName" placeholder="Goal Name (e.g., Learn Spanish)">
                            <select id="lifeGoalCategory">
                                ${lifeGoalCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                            </select>
                            <select id="lifeGoalPriority">
                                <option value="low">Low Priority</option>
                                <option value="medium" selected>Medium Priority</option>
                                <option value="high">High Priority</option>
                            </select>
                        </div>
                        <div class="form-inline">
                            <textarea id="lifeGoalDescription" placeholder="Description (optional)" style="grid-column: 1/-1; min-height: 60px;"></textarea>
                        </div>
                        <div class="form-inline">
                            <input type="date" id="lifeGoalDate" placeholder="Target Date">
                        </div>
                        <button class="btn btn-primary" onclick="addLifeGoal()">Add Life Goal</button>
                    </div>
                    <div class="grid grid-2">${lifeGoalCards || '<div class="empty-state"><h3>No life goals yet</h3><p>Create your first life goal to organize your personal development</p></div>'}</div>`;
                }

                appEl.innerHTML = '<header class="header"><div class="header-content">' +
                    '<div class="header-top"><div class="logo" style="cursor: pointer;" onclick="showHome()"><svg width="32" height="32" fill="#4f46e5" viewBox="0 0 24 24"><path d="M19 14V6c0-1.1-.9-2-2-2H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zm-9-1c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm13-6v11c0 1.1-.9 2-2 2H4v-2h17V7h2z"/></svg><h1 class="logo-title">DoughMain</h1></div>' +
                    '<div class="user-info"><span class="user-email">' + currentUser.email + '</span><button class="btn-logout" onclick="signOut(auth)">Sign Out</button></div></div>' +
                    '<nav class="nav-tabs">' +
                    '<button class="nav-tab ' + (activeTab === 'dashboard' ? 'active' : '') + '" onclick="switchTab(\'dashboard\')">Dashboard</button>' +
                    '<button class="nav-tab ' + (activeTab === 'transactions' ? 'active' : '') + '" onclick="switchTab(\'transactions\')">Transactions</button>' +
                    '<button class="nav-tab ' + (activeTab === 'budgets' ? 'active' : '') + '" onclick="switchTab(\'budgets\')">Budgets</button>' +
                    '<button class="nav-tab ' + (activeTab === 'goals' ? 'active' : '') + '" onclick="switchTab(\'goals\')">Goals</button>' +
                    '<button class="nav-tab ' + (activeTab === 'lifeGoals' ? 'active' : '') + '" onclick="switchTab(\'lifeGoals\')">Life Goals</button>' +
                    '<button class="nav-tab ' + (activeTab === 'accounts' ? 'active' : '') + '" onclick="switchTab(\'accounts\')">Accounts</button>' +
                    '<button class="nav-tab ' + (activeTab === 'analytics' ? 'active' : '') + '" onclick="switchTab(\'analytics\')">Analytics</button>' +
                    '</nav></div></header>' +
                    '<main class="main-content">' + content + '</main>';
            } else if (currentPage === 'auth') {
                appEl.innerHTML = showAuthPage();
            } else {
                appEl.innerHTML = showHomepage();
            }
        }

        // Transaction form handlers
        function addTransaction() {
            var desc = document.getElementById('txDesc').value.trim();
            var amount = document.getElementById('txAmount').value;
            var category = document.getElementById('txCategory').value;
            var type = document.getElementById('txType').value;
            var date = document.getElementById('txDate').value;
            
            if (!desc || !amount) { 
                showNotification('Please fill in description and amount', 'error');
                return; 
            }
            
            saveTransaction(desc, amount, category, type, date);
            
            // Clear form
            document.getElementById('txDesc').value = '';
            document.getElementById('txAmount').value = '';
            document.getElementById('txDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('txForm').classList.add('hidden');
        }

        function editTransaction(id) {
            editingTransaction = id;
            render();
        }

        function cancelEditTransaction() {
            editingTransaction = null;
            render();
        }

        function saveEditTransaction(id) {
            var desc = document.getElementById('editDesc').value.trim();
            var amount = document.getElementById('editAmount').value;
            var category = document.getElementById('editCategory').value;
            var type = document.getElementById('editType').value;
            var date = document.getElementById('editDate').value;
            
            if (!desc || !amount) { 
                showNotification('Please fill in all fields', 'error');
                return; 
            }
            
            updateTransaction(id, desc, amount, category, type, date);
        }

        // Budget form handlers
        function addBudget() {
            var category = document.getElementById('budgetCategory').value;
            var limit = document.getElementById('budgetLimit').value;
            
            if (!category || !limit) { 
                showNotification('Please fill in all fields', 'error');
                return; 
            }
            
            saveBudget(category, limit);
            
            // Clear form
            document.getElementById('budgetLimit').value = '';
            document.getElementById('budgetForm').classList.add('hidden');
        }

        // Goal form handlers
        function addGoal() {
            var name = document.getElementById('goalName').value.trim();
            var target = document.getElementById('goalTarget').value;
            var current = document.getElementById('goalCurrent').value || '0';
            var date = document.getElementById('goalDate').value;
            
            if (!name || !target) { 
                showNotification('Please fill in goal name and target amount', 'error');
                return; 
            }
            
            saveGoal(name, target, current, date);
            
            // Clear form
            document.getElementById('goalName').value = '';
            document.getElementById('goalTarget').value = '';
            document.getElementById('goalCurrent').value = '0';
            document.getElementById('goalDate').value = '';
            document.getElementById('goalForm').classList.add('hidden');
        }

        // Life Goal form handlers
        function addLifeGoal() {
            var name = document.getElementById('lifeGoalName').value.trim();
            var category = document.getElementById('lifeGoalCategory').value;
            var description = document.getElementById('lifeGoalDescription').value.trim();
            var date = document.getElementById('lifeGoalDate').value;
            var priority = document.getElementById('lifeGoalPriority').value;
            
            if (!name || !category) { 
                showNotification('Please fill in goal name and category', 'error');
                return; 
            }
            
            saveLifeGoal(name, category, description, date, priority);
            
            // Clear form
            document.getElementById('lifeGoalName').value = '';
            document.getElementById('lifeGoalDescription').value = '';
            document.getElementById('lifeGoalDate').value = '';
            document.getElementById('lifeGoalForm').classList.add('hidden');
        }

        async function deleteGoal(id) {
            if (!currentUser || !confirm('Are you sure you want to delete this goal?')) return;
            try {
                await deleteDoc(doc(db, 'users', currentUser.uid, 'goals', id));
                await loadUserData();
                showNotification('Goal deleted successfully!', 'success');
                render();
            } catch (error) {
                showNotification('Error deleting goal: ' + error.message, 'error');
            }
        }

        // Filter and search functions
        function updateSearch(term) {
            searchTerm = term;
            render();
        }

        function updateFilter(type, value) {
            if (type === 'category') {
                filterCategory = value;
            } else if (type === 'type') {
                filterType = value;
            }
            render();
        }

        // Account management
        async function deleteAccount(accountId) {
            if (!currentUser || !accountId) return;
            
            var accountToDelete = null;
            for (var i = 0; i < accounts.length; i++) {
                if (accounts[i].account_id === accountId || accounts[i].id === accountId) {
                    accountToDelete = accounts[i];
                    break;
                }
            }
            
            var accountName = accountToDelete ? (accountToDelete.name || 'this account') : 'this account';
            
            if (!confirm('Are you sure you want to delete ' + accountName + '? This will also delete all associated transactions and cannot be undone.')) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'users', currentUser.uid, 'accounts', accountId));
                
                var txSnapshot = await getDocs(collection(db, 'users', currentUser.uid, 'transactions'));
                var deletePromises = [];
                
                txSnapshot.docs.forEach(function(txDoc) {
                    var txData = txDoc.data();
                    if (txData.account_id === accountId) {
                        deletePromises.push(deleteDoc(doc(db, 'users', currentUser.uid, 'transactions', txDoc.id)));
                    }
                });
                
                await Promise.all(deletePromises);
                await loadUserData();
                render();
                
                showNotification('Account deleted successfully', 'success');
            } catch (error) {
                console.error('Error deleting account:', error);
                showNotification('Error deleting account: ' + error.message, 'error');
            }
        }

        // Listen for auth state changes
        onAuthStateChanged(auth, function(user) {
            if (user) {
                currentUser = user;
                loadUserData().then(function() {
                    render();
                });
            } else {
                currentUser = null;
                transactions = [];
                accounts = [];
                goals = [];
                render();
            }
        });

        // Global function exports
        window.showAuth = showAuth;
        window.showHome = showHome;
        window.toggleAuth = toggleAuth;
        window.handleAuth = handleAuth;
        window.handleGoogleSignIn = handleGoogleSignIn;
        window.addTransaction = addTransaction;
        window.editTransaction = editTransaction;
        window.cancelEditTransaction = cancelEditTransaction;
        window.saveEditTransaction = saveEditTransaction;
        window.deleteTransaction = deleteTransaction;
        window.addBudget = addBudget;
        window.addGoal = addGoal;
        window.updateGoalProgress = updateGoalProgress;
        window.deleteGoal = deleteGoal;
        window.saveLifeGoal = saveLifeGoal;
        window.updateLifeGoalStatus = updateLifeGoalStatus;
        window.addMilestone = addMilestone;
        window.deleteLifeGoal = deleteLifeGoal;
        window.connectBankAccount = connectBankAccount;
        window.updateAccountBalances = updateAccountBalances;
        window.deleteAccount = deleteAccount;
        window.updateSearch = updateSearch;
        window.updateFilter = updateFilter;
        window.exportTransactions = exportTransactions;
        window.render = render;
        
        window.signOut = function() {
            signOut(auth).catch(function(error) {
                console.error('Sign out error:', error);
            });
        };
        window.auth = auth;
        
        window.switchTab = function(tabName) {
            activeTab = tabName;
            render();
        };
        
        Object.defineProperty(window, 'activeTab', {
            get: function() { return activeTab; },
            set: function(val) { activeTab = val; }
        });
        
        // Initial render
        render();
    </script>
</body>
</html>
